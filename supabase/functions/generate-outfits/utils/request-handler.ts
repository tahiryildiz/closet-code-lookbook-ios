
import { corsHeaders, createResponse } from './cors.ts';
import { createOutfitPrompt } from './prompt-generator.ts';
import { processValidatedOutfits } from './enhanced-processor.ts';
import { generateFallbackOutfits } from './fallback-generator.ts';

export async function handleOutfitGeneration(requestData: any, openAIApiKey: string) {
  const { occasion, timeOfDay, weather, wardrobeItems, userGender } = requestData;

  console.log('ğŸš€ KombinAI: STRICT outfit generation started');
  console.log('ğŸ“Š Parameters:', { occasion, timeOfDay, weather, userGender, wardrobeCount: wardrobeItems?.length });
  
  if (wardrobeItems && wardrobeItems.length > 0) {
    console.log('ğŸ‘• Wardrobe items:', wardrobeItems.map((item: any) => ({
      name: item.name,
      category: item.category,
      color: item.primary_color || item.color
    })));
  }

  // Validate required parameters
  if (!occasion || !timeOfDay || !weather) {
    throw new Error('Missing required parameters');
  }

  if (!wardrobeItems || wardrobeItems.length === 0) {
    throw new Error('No wardrobe items provided');
  }

  // Create ULTRA-STRICT prompt with exact item names and gender context
  const prompt = createOutfitPrompt(wardrobeItems, occasion, timeOfDay, weather, userGender);
  console.log('ğŸ“ Generated prompt (preview):', prompt.substring(0, 500) + '...');

  console.log('ğŸ¤– Sending STRICT validation prompt to AI with gender context...');

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${openAIApiKey}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        { 
          role: 'system', 
          content: `Sen KombinAI profesyonel stil danÄ±ÅŸmanÄ±sÄ±n. KESINLIKLE SADECE verilen gardroba Ã¼rÃ¼nlerini kullan. ÃœrÃ¼n isimlerini TAM OLARAK AYNI ÅEKÄ°LDE yaz. BaÅŸka Ã¼rÃ¼n EKLEME veya DEÄÄ°ÅTÄ°RME. KullanÄ±cÄ±nÄ±n cinsiyetine uygun stil Ã¶nerileri ver. SADECE geÃ§erli JSON dÃ¶ndÃ¼r.` 
        },
        { role: 'user', content: prompt }
      ],
      temperature: 0.1, // Minimum temperature for maximum consistency
      max_tokens: 1500,
    }),
  });

  console.log('ğŸ¤– AI response status:', response.status);

  if (!response.ok) {
    const errorText = await response.text();
    console.error('âŒ OpenAI API error:', response.status, errorText);
    throw new Error(`OpenAI API error: ${response.status}`);
  }

  const data = await response.json();
  let generatedContent = data.choices[0].message.content;

  console.log('ğŸ¤– Raw AI response:', generatedContent);

  // Clean JSON response
  generatedContent = generatedContent.trim();
  if (generatedContent.startsWith('```json')) {
    generatedContent = generatedContent.replace(/```json\n?/, '').replace(/\n?```$/, '');
  }
  if (generatedContent.startsWith('```')) {
    generatedContent = generatedContent.replace(/```\n?/, '').replace(/\n?```$/, '');
  }

  try {
    const parsedOutfits = JSON.parse(generatedContent);
    
    if (!parsedOutfits.outfits || parsedOutfits.outfits.length === 0) {
      throw new Error('No outfits generated by AI');
    }

    console.log('ğŸ¯ AI generated outfits:', parsedOutfits.outfits.length);
    console.log('ğŸ“‹ Outfit preview:', parsedOutfits.outfits.map((o: any) => ({
      name: o.name,
      items: o.items
    })));

    // Process with ULTRA-STRICT validation
    const validatedOutfits = await processValidatedOutfits(
      parsedOutfits.outfits, 
      wardrobeItems, 
      occasion, 
      timeOfDay, 
      weather, 
      openAIApiKey
    );

    if (validatedOutfits.length === 0) {
      console.log('âŒ ALL AI OUTFITS FAILED VALIDATION - Using safe fallback');
      const fallbackOutfits = generateFallbackOutfits(wardrobeItems, occasion, weather);
      
      return {
        outfits: fallbackOutfits,
        warning: 'AI kombinleri geÃ§ersizdi, gardÄ±robunuzdan gÃ¼venli kombinler oluÅŸturuldu.',
        validation_failed: true
      };
    }

    console.log('ğŸ‰ STRICT VALIDATION SUCCESSFUL!');
    console.log('âœ… Final validated outfits:', validatedOutfits.length);
    
    return { 
      outfits: validatedOutfits,
      validation_passed: true,
      strict_validation: true
    };
    
  } catch (parseError) {
    console.error('âŒ Failed to parse AI response:', parseError);
    console.log('ğŸ›Ÿ Using fallback generator due to parse error');
    
    // Enhanced fallback with exact wardrobe items
    const fallbackOutfits = generateFallbackOutfits(wardrobeItems, occasion, weather);

    return {
      outfits: fallbackOutfits,
      warning: 'AI servisi kullanÄ±lamadÄ±, gardÄ±robunuzdan gÃ¼venli kombinler oluÅŸturuldu.',
      fallback_used: true
    };
  }
}
